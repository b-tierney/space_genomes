# notes on anvio metapangenome test run

var=( {a..z}{a..z}{a..z} )
i=0
rm -rf metapangenome

for file in *fna;

do

i=$((i+1))

alphavar=${var[i]}

anvi-script-reformat-fasta --seq-type NT --simplify-names --prefix $alphavar -o "$file"_reformatted $file  

echo $file $alphavar >> metapangenome_contig_prefix_mapping

done

cat *_reformatted  > all_contigs.fna

anvi-gen-contigs-database -T 8 -f all_contigs.fna -o ap_isolate_genomes.db -n 'AP isolate genomes'

# run hmms
anvi-run-hmms -c ap_isolate_genomes.db --num-threads 4

# run cogs
anvi-run-ncbi-cogs -c ap_isolate_genomes.db -T 4

# generate bowtie index
bowtie2-build all_contigs.fna ap_isolate_genomes_bowtie

# run bowtie_samples.sh 
while read p; do
    sample=$(echo $p | cut -f1 -d' ')
    r1=$(echo $p | cut -f2 -d' ')
    r2=$(echo $p | cut -f3 -d' ')    
    if [ "$sample" == "sample" ]; then continue; fi
    echo $sample
    bowtie2 --threads 4  -x ap_isolate_genomes_bowtie -1 "$r1" -2 "$r2" --no-unal -S "$sample".sam
    samtools view -F 4 -bS "$sample".sam > "$sample"-RAW.bam
    samtools sort "$sample"-RAW.bam -o "$sample".bam
    samtools index "$sample".bam
    rm $sample.sam "$sample"-RAW.bam
done<samples.txt

# anvio_profile.sh
for sample in `awk '{print $1}' samples.txt`
do
    if [ "$sample" == "sample" ]; then continue; fi

    anvi-profile -c ap_isolate_genomes.db \
                 -i $sample.bam \
                 -M 100 \
                 --skip-SNV-profiling \
                 --num-threads 4 \
                 -o $sample
done

# anvi-merge
anvi-merge */PROFILE.db \
           -o ap-MERGED \
           -c ap_isolate_genomes.db

for split_name in `sqlite3 ap_isolate_genomes.db 'select split from splits_basic_info;'`
do
    GENOME=`echo $split_name | cut -f1 -d_`
    echo -e "$split_name\t$GENOME"
done > ap_isolate_genomes.txt

anvi-import-collection ap_isolate_genomes.txt \
                       -c ap_isolate_genomes.db \
                       -p ap-MERGED/PROFILE.db \
                       -C Genomes

anvi-summarize -c ap_isolate_genomes.db \
               -p ap-MERGED/PROFILE.db \
               -C Genomes \
               --init-gene-coverages \
               -o ap-SUMMARY

### GENERATE THE PANGENOME

anvi-gen-genomes-storage -i internal_genomes.txt \
                         -o ap-PAN-GENOMES.db

anvi-pan-genome -g ap-PAN-GENOMES.db \
                --use-ncbi-blast \
                --minbit 0.5 \
                --mcl-inflation 10 \
                --project-name ap-PAN \
                --num-threads 10

<collection step>

anvi-summarize -p ap-PAN/ap-PAN-PAN.db \
               -g ap-GENOMES.db \
               -C default \
               -o ap-PAN-SUMMARY

### linking db

anvi-gen-samples-info-database -D ap-METAGENOME-samples-information.txt \
-R ap-PAN/ap-PAN-samples-order.txt \
-o ap-METAPAN-SAMPLES.db

### lookin at genes across database

# generate gene-level distribution data for MIT9314:
anvi-script-gen-distribution-of-genes-in-a-bin -p Prochlorococcus-MERGED/PROFILE.db \
                                               -c Prochlorococcus-CONTIGS.db \
                                               -C Genomes \
                                               --fraction-of-median-coverage 0.25 \
                                               -b MIT9314 \
                                               -o MIT9314-ENV-DETECTION.txt


# do the same for EQPAC1:
anvi-script-gen-distribution-of-genes-in-a-bin -p Prochlorococcus-MERGED/PROFILE.db \
                                               -c Prochlorococcus-CONTIGS.db \
                                               -C Genomes \
                                               --fraction-of-median-coverage 0.25 \
                                               -b EQPAC1 \
                                               -o EQPAC1-ENV-DETECTION.txt


























