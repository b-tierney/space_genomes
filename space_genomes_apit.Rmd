---
title: "space_genomes_apit"
author: "Braden T Tierney"
date: "9/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggtree)
library(tidyverse)
library(ggnewscale)
library(reshape2)
library(pheatmap)
```

```{r}
#load, plot, and annotate ggtree 
setwd('~/Dropbox (Mason Lab)/space_genomes/ap_subproject/')

tree <- read.tree("gtdbtk.unrooted.tree")
metadata = read.table('metadata.csv',header=T,sep=',') %>% mutate(Assembly = strsplit(Assembly,'\\.') %>% map_chr(1))

environmental_metadata = read.csv('environmental_metadata.csv') %>% mutate(Assembly = strsplit(Assembly,'\\.') %>% map_chr(1))

metadata = left_join(metadata,environmental_metadata)

rownames(metadata)=metadata$Assembly
metadata = metadata %>% select(-Assembly,Project,isolation_source_cleaned,space_vs_earth_source) %>% mutate(Project = if_else(Project=='','NON-ISS',Project))

metadata$Project = as.factor(metadata$Project)
metadata$isolation_source = as.factor(metadata$isolation_source_cleaned)
metadata$space_vs_earth_source = as.factor(metadata$space_vs_earth_source)

new_tip_labels = list()
for(i in seq(tree$tip.label)){
   val = tree$tip.label[[i]]
   new_tip_labels[[i]] = as.character(metadata[val,'isolation_source_cleaned'])
}

new_tip_labels=unlist(unname(new_tip_labels))

labelmap = data.frame(label = tree$tip.label, newlabel = new_tip_labels)

p = ggtree(tree,branch.length="none",layout = "circular") + geom_treescale() 

p2=gheatmap(p, metadata %>% select(space_vs_earth_source), offset=0, width=.1, colnames=FALSE, legend_title="Isolation Source")+ scale_fill_viridis_d(option="D", name="Isolation Source")  

p3 = p2 %<+% labelmap + geom_tiplab(offset = 5,aes(label=newlabel),size = 2, parse = F)

ggsave('apit_tree_314.pdf',height=10,width=10)
```

```{r}
# define clades and select representative 
setwd('~/Dropbox (Mason Lab)/space_genomes/ap_subproject/')

tree <- read.tree("gtdbtk.unrooted.tree")
metadata = read.table('metadata.csv',header=T,sep=',') %>% mutate(Assembly = strsplit(Assembly,'\\.') %>% map_chr(1))

environmental_metadata = read.csv('environmental_metadata.csv') %>% mutate(Assembly = strsplit(Assembly,'\\.') %>% map_chr(1))

metadata = left_join(metadata,environmental_metadata) %>% filter(!is.na(isolation_source_cleaned))

rownames(metadata)=metadata$Assembly
metadata = metadata %>% select(-Assembly,Project,isolation_source_cleaned,space_vs_earth_source) %>% mutate(Project = if_else(Project=='','NON-ISS',Project))

metadata$Project = as.factor(metadata$Project)
metadata$isolation_source = as.factor(metadata$isolation_source_cleaned)
metadata$space_vs_earth_source = as.factor(metadata$space_vs_earth_source)

clades_to_sample = tree %>% as.tibble  %>% filter(grepl('C',label)) %>% select(parent) %>% table %>% data.frame %>%filter(Freq > 2) %>% select(-Freq) %>% unlist %>% unname

tibble_tree = tree %>% as.tibble 
tibble_tree_clades = tibble_tree %>% filter(parent %in% clades_to_sample) 
tibble_tree_clades = left_join(tibble_tree_clades,metadata %>% rownames_to_column('label'))

space_bugs = metadata %>% rownames_to_column('label') %>% filter(space_vs_earth_source == 'ISS') %>% select(label) %>% unlist %>% unname

tibble_tree_clades = tibble_tree_clades %>% filter(!(label %in% space_bugs))

pick_representative_bug <- function(treedf,nodelabel){
  treedf_sub = treedf %>% filter(parent == nodelabel) %>% arrange(Scaffolds)
  treedf_sub_human = treedf_sub %>% filter(human_or_other == 'HUMAN')
  if(nrow(treedf_sub_human) >0){
    representative = treedf_sub_human$label[[1]]
  }
  else{
    representative = treedf_sub$label[[1]]
  }
  return(representative)
}

representative_bugs = map(unique(tibble_tree_clades$parent), function(x) pick_representative_bug(tibble_tree_clades,x)) %>% unlist %>% unname

metadata = metadata %>% mutate(for_anvio = if_else(rownames(metadata) %in% c(representative_bugs, space_bugs),'YES','NO'))

rep_bugs_for_anvio = metadata %>% filter(for_anvio == 'YES')
write.csv(rep_bugs_for_anvio %>% rownames_to_column('assembly') %>% select(assembly,space_vs_earth_source),'representative_and_space_bugs_for_anvio.csv')

new_tip_labels = list()
for(i in seq(tree$tip.label)){
   val = tree$tip.label[[i]]
   new_tip_labels[[i]] = as.character(metadata[val,'isolation_source_cleaned'])
}

new_tip_labels=unlist(unname(new_tip_labels))

labelmap = data.frame(label = tree$tip.label, newlabel = new_tip_labels)

p = ggtree(tree,branch.length="none",layout = "circular") + geom_treescale() 

p2=gheatmap(p, metadata %>% select(space_vs_earth_source), offset=0, width=.1, colnames=FALSE, legend_title="Isolation Source")+ scale_fill_viridis_d(option="D", name="Isolation Source")  

p3 = p2 %<+% labelmap + geom_tiplab(offset = 7.5,aes(label=newlabel),size = 2, parse = F) + new_scale_fill()

p4 = gheatmap(p3, metadata %>% select(for_anvio), offset=3, width=.1, colnames=FALSE, legend_title="Used in anvio")+ scale_fill_viridis_d(option="A", name="Used in anvio")  

ggsave('apit_tree_314_withanvioannotation.pdf',height=10,width=10)
```


```{r}
# load in and visualize mash data

### distances generated with:
# mash sketch -s 10000 -o mash_sketch bacterial_genomes_actually_pittii/*.fna
# mash dist mash_sketch.msh mash_sketch.msh > apit_mash.tsv
setwd('~/Dropbox (Mason Lab)/space_genomes/ap_subproject/')

mashdata = read.table('apit_mash.tsv',header=F,sep='\t') %>% mutate(V1 = strsplit(V1,'/') %>% map_chr(2) %>% strsplit('\\.') %>% map_chr(1))  %>% mutate(V2 = strsplit(V2,'/') %>% map_chr(2) %>% strsplit('\\.') %>% map_chr(1)) %>% select(V1,V2,V3)
colnames(mashdata) = c('genome_1','genome_2','mash_distance')
hist(mashdata$mash_distance)

mashdata = mashdata %>% reshape2::dcast(genome_1 ~ genome_2,value.var = 'mash_distance') 

mashdata = left_join(mashdata,metadata %>% rownames_to_column('genome_1') %>% select(genome_1,Project)) %>% mutate(Project = if_else(as.character(Project) == 'Non-ISS','',as.character(Project)) %>% as.factor) %>%  column_to_rownames('genome_1') 

mashdata_annotation = mashdata %>% select(Project)
mashdata = mashdata %>% select(-Project)

save_pheatmap_pdf <- function(x, filename, width=8, height=8) {
   stopifnot(!missing(x))
   stopifnot(!missing(filename))
   pdf(filename, width=width, height=height)
   grid::grid.newpage()
   grid::grid.draw(x$gtable)
   dev.off()
}

p = (pheatmap::pheatmap(mat = log(mashdata+0.00001), show_rownames = F,show_colnames = F,annotation_row = mashdata_annotation, cellwidth = 1,cellheight = 1))

save_pheatmap_pdf(p,'mash_distance_heatmap.pdf')

mashdata_sub = mashdata[space_bugs,space_bugs]

p2 = (pheatmap::pheatmap(mat = log(mashdata_sub+0.00001), show_rownames = F,show_colnames = T,annotation_row = mashdata_annotation, cellwidth = 10,cellheight = 10))

save_pheatmap_pdf(p2,'mash_distance_heatmap_zoomed.pdf')

# find closest earthbound relative, for use in SNP discovery 

mashdata_melted = mashdata %>% rownames_to_column() %>% melt
reference_bug = mashdata_melted %>% filter(rowname %in% space_bugs, !(variable %in% space_bugs)) %>% group_by(variable) %>% mutate(average_mash_dist = mean(value)) %>% select(-value,-rowname) %>% unique %>% arrange(average_mash_dist) %>% select(variable) %>% head(1) %>% unlist %>% unname %>% as.character()
print(reference_bug)

# pick an MT1 genome for us in SNP discovery (least similar to all the others)

mt1_bugs = metadata %>% filter(Project=='MT1') %>% rownames %>% unlist %>% unname
reference_mt1_bug = mashdata_melted %>% filter(rowname %in% space_bugs, variable %in% mt1_bugs) %>% group_by(variable) %>% mutate(average_mash_dist = mean(value)) %>% select(-value,-rowname) %>% unique %>% arrange(desc(average_mash_dist))%>% select(variable) %>% head(1) %>% unlist %>% unname %>% as.character()
print(reference_mt1_bug)

```






